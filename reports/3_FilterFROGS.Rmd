---
title: "3_FilterFROGS"
author: "Sylvain Piry, Nicolas Rode"
date: "`r format(Sys.Date(), '%d-%B-%Y')`"
output: 
  html_document:
    theme: "journal"
    toc: true
    toc_depth: 3
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: console
---


```{r setup, include =FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
devtools::load_all()
```


Work on an abundance file, a taxonomic file and a metadata file issued from the script filter_run_frogs.R
These files are "project" based (same number of replicates, same kind of data reduction to do, etc).
This is advised to run the scripts clean_tax.R and filter_run_frogs.R successively on raw files from Frogs files filtering with filter_project_v2.R.

Explore coverage, check rarefaction and replicate correlation (figures).

Filter data:
 - filter1: transform abundance data to null under a theshold estimated from alien controls (set with alien_in_samples = yes) or from an input value (set with alien_in_samples = no and rfa).
   Controls for index contamination following correction 2 from Galan et al. 2016 (Tfa).
 - filter2: keep positive data only if congruent between replicates (2 or 3) and merge replicates
 - filter3: transform abundance data to null under a theshold estimated from negative controls.
   Controls for extraction & pcr contamination following correction 1 from Galan et al. 2016 (Tcc).

 Reduce data (optional):
 - red1: keep taxa that fit a criterion on sum taxa (set with red1).
 - red2: keep samples that fit a criterion on sum samples (set with red2).

Export each filtered abundance table and a summary file with number of seqs and number of clusters.
# Import data
```{r }

#the samples must be arranged by biological units (technical replicates of a same biological unit follow each other)
#if it is not the case, arrange them properly in your sample_data (metadata), then activate the following lines
# correct.order.samples<-rownames(sample)
# table<-table[,correct.order.samples]

sample <- read.csv(file=file.path(here::here(), "data", "raw_data", "Sample_ISS.xlsx - Metadata.csv"), header=TRUE, sep=",") #to modify (name of the metadata file)
head(sample)
sample <- phyloseq::sample_data(sample)

name <- "2022JRLAT-16S" #name will be used to import files and write names before extension of the different output tables. to modify
raw <- data.table::fread(file = file.path(here::here(), "data", "derived_data", paste(name,"_cleaned_abundance.txt",sep="")), sep="\t",header=TRUE) #to modify (input tsv file from Frogs)
head(raw)
#name<-sub("\\_.*$", "", rawname) #name will be used to write names before extension of the different output tables. to modify if necessary (the character "_" is used to substract basename)

raw$observation_sum <- NULL
rownames(raw) <- raw$observation_name

## Table with cleaned abundances
table <- raw[, (-(1:10)),with=FALSE]
head(table)
all(colnames(table) %in% rownames(sample)) #check name consistency
all(rownames(sample) %in% colnames(table)) #check name consistency
setcolorder(table,rownames(sample))
table<-as.matrix(table)
rownames(table)<-raw$observation_name
table<-otu_table(table,taxa_are_rows = TRUE)

tax<-raw[,(1:8),with=FALSE]
tax<-as.matrix(tax)
rownames(tax)<-raw$observation_name
tax <- tax_table(tax)

data<-phyloseq(sample,table,tax)

# Transform all variables in sample_data to factors just in case...
df <- as.data.frame(lapply(sample_data(data),function (y) if(class(y)!="factor" ) as.factor(y) else y),stringsAsFactors=T)
row.names(df) <- sample_names(data)
sample_data(data) <- sample_data(df)

data 
rm(raw)


```